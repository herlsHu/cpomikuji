<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°·è¯­æ—¥ç­¾ - å¨ƒåŒ…è½»é™ªä¼´OC</title>
    
    <!-- å­—ä½“é¢„åŠ è½½ -->
    <link rel="preload" href="fonts/æ–¹æ­£æ ‡é›…å®‹ç¹ä½“.TTF" as="font" type="font/truetype" crossorigin>
    <link rel="preload" href="fonts/æ–¹æ­£æ ‡é›…å®‹ç®€ä½“.TTF" as="font" type="font/truetype" crossorigin>
    
    <style>
        @font-face {
            font-family: 'FZYaSongT-R-GB';
            src: url('fonts/æ–¹æ­£æ ‡é›…å®‹ç¹ä½“.TTF') format('truetype'),
                 local('FZYaSongT-R-GB'), 
                 local('æ–¹æ­£æ ‡é›…å®‹ç¹ä½“');
            font-display: block;
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'FZYaSongS-R-GB';
            src: url('fonts/æ–¹æ­£æ ‡é›…å®‹ç®€ä½“.TTF') format('truetype'),
                 local('FZYaSongS-R-GB'),
                 local('æ–¹æ­£æ ‡é›…å®‹ç®€ä½“');
            font-display: block;
            font-weight: normal;
            font-style: normal;
        }
        
        .font-fallback {
            font-family: 'FZYaSongT-R-GB', 'Source Han Serif SC', 'æ€æºå®‹ä½“', 'Noto Serif SC', 'STSong', 'å®‹ä½“', serif;
        }
        
        .font-fallback-sans {
            font-family: 'FZYaSongS-R-GB', 'Source Han Serif SC', 'æ€æºå®‹ä½“', 'Noto Serif SC', 'STSong', 'å®‹ä½“', serif;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        /* 1. äº¤äº’è§¦å‘ç¯èŠ‚ */
        .trigger-section {
            text-align: center;
        }

        .upload-area {
            margin-bottom: 30px;
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-box:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .upload-box.dragover {
            border-color: #ff6b6b;
            background: #fff5f5;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ccc;
        }

        .upload-text {
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .preview {
            margin-top: 20px;
        }

        .preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* 2. äº¤äº’å¼•å¯¼ç¯èŠ‚ */
        .guide-section {
            display: none;
        }

        .guide-section.show {
            display: block;
        }

        .guide-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #ff6b6b;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .guide-item.show {
            opacity: 1;
            transform: translateY(0);
        }

        .guide-item h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .guide-item p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }

        .guide-icon {
            font-size: 28px;
            margin-bottom: 15px;
        }

        /* 3. å¼•å¯¼ç­‰å¾…ç¯èŠ‚ */
        .waiting-section {
            display: none;
            text-align: center;
        }

        .waiting-section.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-text {
            font-size: 20px;
            color: #333;
            font-weight: bold;
        }

        /* 4. ç»“æœè·å–ç¯èŠ‚ */
        .result-section {
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-image {
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }


        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .content {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>è°·è¯­æ—¥ç­¾</h1>
            <p>å¨ƒåŒ…è½»é™ªä¼´OC</p>
        </div>

        <div class="content">
            <!-- 1. äº¤äº’è§¦å‘ç¯èŠ‚ -->
            <div class="trigger-section" id="triggerSection">
                <div class="upload-area">
                    <div class="upload-box" id="uploadBox">
                        <div class="upload-icon">ğŸ“·</div>
                        <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                        <input type="file" id="fileInput" class="file-input" accept="image/*">
                        <button class="btn" onclick="document.getElementById('fileInput').click()">
                            é€‰æ‹©å›¾ç‰‡
                        </button>
                    </div>
                    
                    <div class="preview" id="preview"></div>
                    
                    <button class="btn" id="startBtn" onclick="startOmikuji()" style="display: none;">
                        å¼€å§‹æŠ½å–æ—¥ç­¾
                    </button>
                </div>
            </div>

            <!-- 2. äº¤äº’å¼•å¯¼ç¯èŠ‚ -->
            <div class="guide-section" id="guideSection">
                <div class="guide-item" id="guideItem1">
                    <div class="guide-icon">ğŸ’</div>
                    <h3>æ”¾ç½®å¨ƒåŒ…</h3>
                    <p>è¯·æŠŠå¨ƒåŒ…æ”¾åœ¨å åœå°æ­£ä¸­å¤®åœˆèµ·çš„åŒºåŸŸ</p>
                </div>
                
                <div class="guide-item" id="guideItem2">
                    <div class="guide-icon">ğŸ‘¤</div>
                    <h3>ç«™ç«‹ä½ç½®</h3>
                    <p>è¯·åé€€ä¸€æ­¥ç«™åœ¨æŒ‡å®šä½ç½®ï¼Œè®©è°·è¯­å¨ƒåŒ…èƒ½å¤Ÿçœ‹åˆ°ä½ çš„ä»Šæ—¥çŠ¶æ€</p>
                </div>
            </div>

            <!-- 3. å¼•å¯¼ç­‰å¾…ç¯èŠ‚ -->
            <div class="waiting-section" id="waitingSection">
                <div class="spinner"></div>
                <div class="waiting-text">æ­£åœ¨åˆ†æä½ çš„ä»Šæ—¥è¿åŠ¿â€¦â€¦</div>
            </div>

            <!-- 4. ç»“æœè·å–ç¯èŠ‚ -->
            <div class="result-section" id="resultSection">
                <img id="resultImage" class="result-image" alt="ç”Ÿæˆçš„æ—¥ç­¾">
                
                
                <button class="btn" onclick="downloadImage()">
                    ä¿å­˜æ—¥ç­¾
                </button>
                
                <button class="btn btn-secondary" onclick="resetAll()">
                    é‡æ–°æŠ½å–
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let selectedFile = null;
        let generatedImage = null;
        let omikujiResult = null;

        // è¯åº“æ•°æ®
        const wordBank = {
            "grade": ["å¤§å‰"],
            "yi": [
                "æ—©æ’é˜Ÿ","è½»è£…ä¸Š","äºŒå·¡é€›","è¡¥æ°´ç«™","æ‰“å¡ç‚¹","åˆç…§ç¤¼",
                "ç©¿èˆ’é‹","å¸¦å……ç”µ","è´´é˜²ç£¨","é˜²æ™’ä¼","å¤‡é›¨å…·","å°é›¶é’±",
                "è´´åç‰Œ","å­˜è¡Œæ","å…ˆå¤–åœˆ","çœ‹æŒ‡å¼•","æ’é˜Ÿè·","é¿å°–å³°",
                "å…ˆåƒé¥­","å–„è®©è·¯","ä¸»åŠ¨é—®","æ¸©å£°è¯­","å¸®æ‹ç…§","æ”¶ç¥¨æ®",
                "æ¢è½»åŒ…","æŠ¤é“å…·","æ‹‰æ‹‰é“¾","å…ˆè¯•ç¯","è®°æ‘Šå·","å¤‡æ¹¿å·¾",
                "æ¢å£ç½©","å›æ”¶è¢‹","é˜²èµ°å¤±","çº¦é›†åˆ","è½»å–ç‰©","å…ˆè§‚æ™¯",
                "éšæ‰‹é€’","ç¤¼è²Œé€€","å¤šå¾®ç¬‘","é€‚æ—¶ä¼‘",
                "çœ‹åœºåˆŠ","æŒ‰åŠ¨çº¿","æ ‡è¿”å›¾","æ‰©åˆ—ç¤¼","æŠ¤å‡å‘","æ”¶å°ç« ",
                "é¿åå…‰","å…³é—ªå…‰","ç•™ç©ºé“","è®©åæ’"
            ],
            "ji": [
                "ä¹…ä¹…ç«™","å¿˜å……ç”µ","ç¡¬æŠ¢ä½","å¤§åŒ…è£¹","ç©ºè…¹é€›",
                "æ’é˜ŸæŠ¢","å¤§å£°åµ","ä¹±æ‹æ‘„","æœªåŒæ„","æŒ¤å‹äºº",
                "æ‰åƒåœ¾","æ’é“å…·","è¸©è£™æ‘†","è¿½ç€æ‹","ä¹…ä¸æ°´",
                "è¿‡åº¦æ™’","ç©¿æ–°é‹","æ‹–åœ°è£™","ç´§è·Ÿæ‹","å µé€šé“",
                "å åº§ä¹…","é—ªç¯çŒ›","æ‹‰ä»–äºº","ä¹±è´´ç­¾","ä¸¢ç¥¨è¯",
                "æ”¾éšåœ°","å–å¤ªå°‘","è´Ÿé‡å¤š","æ¨æ¡äºº","ä¹±ç¿»åŒ…",
                "æœªæ’é˜Ÿ","è¶ŠæŠ¤æ ","é†‰é…’é€›","é€¼åˆç…§","ç¡¬å€Ÿç‰©",
                "ä¹±æ‰©åˆ—","å¼€é—ªå…‰","æŒ¡é€šé“","è´´äººæ‹","è¸©é“å…·",
                "ä¹±ç›–ç« ","æŒ¡æ‘Šä½","å æœºä½"
            ],
            "lucky_items": ["æ‰“å¡æ£’","è¢‹å­"],
            "omikuji": [
                "å¿µå¿µä¸å¿˜ å¿…æœ‰å›å“",
                "æ—©åˆ°ä¸æ€¥ å¥½ä½è‡ªç•™",
                "ç¯ç‰Œä½œæœˆ å‡ºç‰‡æ›´ç¨³",
                "äºŒå·¡æœ‰ç¼˜ æ¼ç½‘å…¥è¢‹",
                "åœºåˆŠåœ¨æ‰‹ æ–¹å‘è‡ªæ˜",
                "ç¤¼è²Œå…ˆè¡Œ ç¼˜åˆ†é è¿‘",
                "å…ˆé—®åæ‹ å‡ºç‰‡è‡ªæ¥",
                "æ‰©åˆ—é¡ºåˆ© æœ‹å‹å¸¸ä¼´",
                "æ­£ç‰‡æœ‰æœŸ è¿”å›¾å¦‚çº¦",
                "è°·å­åˆ°æ‰‹ å¿ƒæ»¡æ„è¶³",
                "å§å”§å®å½“ æ¬§æ°”æŠ¤ä½“",
                "ç—›åŒ…é—ªäº® äººæµ·å‘å…‰",
                "é”™å³°è€Œè¡Œ è„šæ­¥è½»å¿«",
                "æ’é˜Ÿæœ‰åº æ¬§æ°”é è¿‘",
                "è½»è£…ä¸Šé˜µ é£ç”Ÿæ°´èµ·",
                "é›†ç« é›†å‹ å¿«ä¹åŠ å€",
                "è¿”åœºå°èš å¥½è¿åŠ å€",
                "å¤–åœºå¾®é£ ç…§ç‰‡ç”ŸèŠ±",
                "æ¸©å£°ç›¸å¾… å¥½äº‹ä¸Šé—¨",
                "è¿·è·¯ä¸æ…Œ åŸåœ°ç­‰å‹",
                "é¥®æ°´åŠæ—¶ ä½“åŠ›å¸¸é’",
                "è¿œå…‰ä½œä¼´ å½±åƒç”Ÿè¾‰",
                "æŒ‡å—åœ¨æ‰‹ åŠ¨çº¿æ˜æ™°",
                "åˆç…§å¾®ç¬‘ è®°å¾—è‡´è°¢",
                "æŠ¤å¥½å‡å‘ ç»†èŠ‚åœ¨çº¿",
                "æŒ‚ä»¶ç¨³å›º ç—›åŒ…å®‰å¿ƒ",
                "æ”¶çº³æœ‰æœ¯ æˆ˜åˆ©æ»¡è¢‹",
                "ä»Šæ—¥é¡ºå¿ƒ ä¸‡äº‹èƒœæ„",
                "äº‘å¼€è§ä½  ç¦æ·»ä¸€å±‚",
                "å¿ƒæœ‰çƒ­çˆ± å®‡å®™å›å“",
                "ç¯ç«å¯äº² ç¬‘è„¸å¸¸æ–°"
            ],
            "warm_tips": [
                "é”™å³°äºŒå·¡æ›´è½»æ¾",
                "ç¯ç‰Œè¡¥å…‰æ›´é€šé€",
                "æ’é˜Ÿç•™é—´è·å°±å¥½",
                "åˆç…§æœ‰ç¤¼æ›´å¥½çœ‹",
                "ç—›åŒ…æŒ‚ç‰¢æ›´å®‰å¿ƒ",
                "å§å”§å¥—å£³ä¸åˆ®èŠ±",
                "å…ˆåƒå†é€›æ›´è€ä¹…",
                "ç¥¨è¯æ”¶å¥½æ›´çœå¿ƒ",
                "é›†ç« æ…¢æ…¢ç›–ä¸ç€æ€¥",
                "æ‰©åˆ—è‡ªæˆ‘ä»‹ç»å…ˆ",
                "å–œæ¬¢å°±è¡¨è¾¾è¯•è¯•",
                "å–æ°´ä¼‘æ¯æ›´æœ‰åŠ²",
                "è¿œå…‰ä¾§èº«æ›´é€šé€",
                "æŒ‡å—åœ¨æ‰‹æ›´è¸å®"
            ]
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadBox = document.getElementById('uploadBox');
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½äº‹ä»¶
            uploadBox.addEventListener('dragover', handleDragOver);
            uploadBox.addEventListener('dragleave', handleDragLeave);
            uploadBox.addEventListener('drop', handleDrop);
        });

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedFile = file;
                showPreview(file);
                showStartButton();
            }
        }

        // å¤„ç†æ‹–æ‹½
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    selectedFile = file;
                    showPreview(file);
                    showStartButton();
                }
            }
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview(file) {
            const preview = document.getElementById('preview');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆå›¾ç‰‡">`;
            };
            
            reader.readAsDataURL(file);
        }

        // æ˜¾ç¤ºå¼€å§‹æŒ‰é’®
        function showStartButton() {
            document.getElementById('startBtn').style.display = 'block';
        }

        // å¼€å§‹æŠ½å–æ—¥ç­¾
        async function startOmikuji() {
            if (!selectedFile) return;
            
            // 1. éšè—è§¦å‘ç¯èŠ‚ï¼Œæ˜¾ç¤ºå¼•å¯¼ç¯èŠ‚
            document.getElementById('triggerSection').classList.add('hidden');
            document.getElementById('guideSection').classList.add('show');
            
            // 2. ä¾æ¬¡æ˜¾ç¤ºå¼•å¯¼å†…å®¹
            setTimeout(() => {
                document.getElementById('guideItem1').classList.add('show');
            }, 500);
            
            setTimeout(() => {
                document.getElementById('guideItem2').classList.add('show');
            }, 5500); // bå‡ºç°5ç§’åæ˜¾ç¤ºc
            
            // 3. å»¶è¿Ÿæ˜¾ç¤ºç­‰å¾…ç¯èŠ‚
            setTimeout(() => {
                document.getElementById('guideSection').classList.remove('show');
                document.getElementById('waitingSection').classList.add('show');
            }, 13500); // cå‡ºç°8ç§’åæ˜¾ç¤ºd
            
            // 4. åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆæ—¥ç­¾ï¼ˆç¡®ä¿ç­‰å¾…ç¯èŠ‚è‡³å°‘ä¿æŒ3ç§’ï¼‰
            setTimeout(async () => {
                await analyzeAndGenerate();
            }, 16500); // ç­‰å¾…ç¯èŠ‚è‡³å°‘ä¿æŒ3ç§’ï¼ˆ13.5ç§’ + 3ç§’ = 16.5ç§’ï¼‰
        }

        // åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆæ—¥ç­¾
        async function analyzeAndGenerate() {
            const img = new Image();
            img.onload = function() {
                // åˆ›å»ºcanvasæ¥åˆ†æå›¾ç‰‡é¢œè‰²
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                
                // ç»˜åˆ¶å›¾ç‰‡åˆ°canvas
                ctx.drawImage(img, 0, 0);
                
                // è·å–å›¾ç‰‡æ•°æ®
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // åˆ†æä¸»è‰²è°ƒ
                const dominantColor = analyzeImageColor(imageData);
                console.log('åˆ†æåˆ°çš„ä¸»è‰²è°ƒ:', dominantColor);
                
                // ç”Ÿæˆæ—¥ç­¾ç»“æœ
                omikujiResult = generateOmikujiResult(dominantColor);
                
                // ç”Ÿæˆæ—¥ç­¾å›¾ç‰‡
                generateImage();
            };
            
            img.src = URL.createObjectURL(selectedFile);
        }

        // RGBè½¬HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            
            return [h * 360, s * 100, l * 100];
        }

        // åˆ†æå›¾ç‰‡ä¸»è‰²è°ƒ - ä¼˜åŒ–ç‰ˆï¼Œä¸“é—¨é’ˆå¯¹ç”¨æˆ·ç…§ç‰‡
        function analyzeImageColor(imageData) {
            const data = imageData.data;
            const colorCounts = {};
            const sampleSize = 3000; // å¢åŠ é‡‡æ ·ç‚¹æ•°é‡
            
            const width = imageData.width;
            const height = imageData.height;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // åˆ†å±‚é‡‡æ ·ç­–ç•¥ï¼šé‡ç‚¹å…³æ³¨ç”¨æˆ·èº«ä½“åŒºåŸŸ
            for (let i = 0; i < sampleSize; i++) {
                let x, y;
                
                // 80%æ¦‚ç‡é‡‡æ ·ä¸­å¿ƒåŒºåŸŸï¼ˆç”¨æˆ·èº«ä½“ï¼‰ï¼Œ20%æ¦‚ç‡é‡‡æ ·å…¨å›¾
                if (Math.random() < 0.8) {
                    // ä¸­å¿ƒåŒºåŸŸé‡‡æ ·ï¼Œé‡ç‚¹å…³æ³¨ç”¨æˆ·èº«ä½“
                    const bodyWidth = width * 0.4;  // èº«ä½“å®½åº¦çº¦ä¸ºå›¾ç‰‡å®½åº¦çš„40%
                    const bodyHeight = height * 0.6; // èº«ä½“é«˜åº¦çº¦ä¸ºå›¾ç‰‡é«˜åº¦çš„60%
                    x = Math.floor(centerX + (Math.random() - 0.5) * bodyWidth);
                    y = Math.floor(centerY + (Math.random() - 0.5) * bodyHeight);
                } else {
                    // å…¨å›¾éšæœºé‡‡æ ·
                    x = Math.floor(Math.random() * width);
                    y = Math.floor(Math.random() * height);
                }
                
                const index = (y * width + x) * 4;
                const r = data[index];
                const g = data[index + 1];
                const b = data[index + 2];
                const a = data[index + 3];
                
                // è·³è¿‡é€æ˜åƒç´ å’Œè¿‡æš—åƒç´ 
                if (a < 128 || (r < 20 && g < 20 && b < 20)) continue;
                
                const [h, s, l] = rgbToHsl(r, g, b);
                
                // æ›´ç²¾ç¡®çš„é¢œè‰²åˆ†ç±»
                let colorName = "ç™½";
                
                // æä½äº®åº¦ = é»‘è‰²
                if (l < 8) {
                    colorName = "é»‘";
                }
                // ä½é¥±å’Œåº¦ = ç™½è‰²/ç°è‰²
                else if (s < 12) {
                    if (l > 70) colorName = "ç™½";
                    else if (l > 40) colorName = "ç°";
                    else colorName = "é»‘";
                }
                // é«˜äº®åº¦ä½é¥±å’Œåº¦ = ç™½è‰²
                else if (l > 85 && s < 25) {
                    colorName = "ç™½";
                }
                // æ ¹æ®è‰²ç›¸å’Œé¥±å’Œåº¦åˆ¤æ–­é¢œè‰²ï¼ˆæ›´ç²¾ç¡®çš„é˜ˆå€¼ï¼‰
                else if (h >= 0 && h < 15) {
                    if (s < 30 && l < 50) colorName = "è¤";
                    else if (s < 40 && l < 60) colorName = "æ£•";
                    else colorName = "çº¢";
                }
                else if (h >= 15 && h < 35) {
                    if (s < 35 && l < 55) colorName = "è¤";
                    else if (s < 45 && l < 65) colorName = "æ£•";
                    else colorName = "æ©™";
                }
                else if (h >= 35 && h < 65) {
                    if (s < 30 && l < 50) colorName = "è¤";
                    else if (s < 40 && l < 60) colorName = "æ£•";
                    else colorName = "é»„";
                }
                else if (h >= 65 && h < 140) {
                    if (s < 25 && l < 45) colorName = "è¤";
                    else if (s < 35 && l < 55) colorName = "æ£•";
                    else colorName = "ç»¿";
                }
                else if (h >= 140 && h < 180) {
                    if (s < 30 && l < 50) colorName = "è¤";
                    else if (s < 40 && l < 60) colorName = "æ£•";
                    else colorName = "é’";
                }
                else if (h >= 180 && h < 240) {
                    if (s < 25 && l < 45) colorName = "è¤";
                    else if (s < 35 && l < 55) colorName = "æ£•";
                    else colorName = "è“";
                }
                else if (h >= 240 && h < 280) {
                    if (s < 30 && l < 50) colorName = "è¤";
                    else if (s < 40 && l < 60) colorName = "æ£•";
                    else colorName = "ç´«";
                }
                else if (h >= 280 && h < 320) {
                    if (s < 30 && l < 50) colorName = "è¤";
                    else if (s < 40 && l < 60) colorName = "æ£•";
                    else colorName = "ç²‰";
                }
                else {
                    if (s < 30 && l < 50) colorName = "è¤";
                    else if (s < 40 && l < 60) colorName = "æ£•";
                    else colorName = "çº¢"; // 320-360åº¦å›åˆ°çº¢è‰²
                }
                
                colorCounts[colorName] = (colorCounts[colorName] || 0) + 1;
            }
            
            // æ‰¾åˆ°å‡ºç°æ¬¡æ•°æœ€å¤šçš„é¢œè‰²
            let maxCount = 0;
            let dominantColor = "ç™½";
            for (const [color, count] of Object.entries(colorCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    dominantColor = color;
                }
            }
            
            // å¦‚æœé‡‡æ ·ç‚¹å¤ªå°‘ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            if (maxCount < 15) {
                console.log('é‡‡æ ·ç‚¹ä¸è¶³ï¼Œä½¿ç”¨éšæœºé¢œè‰²');
                const colors = ["ç™½","é»‘","çº¢","æ©™","é»„","ç»¿","é’","è“","ç´«","ç²‰","ç°","è¤","æ£•"];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            console.log('ç”¨æˆ·ç…§ç‰‡é¢œè‰²åˆ†æç»“æœ:', colorCounts);
            console.log('ä¸»è‰²è°ƒ:', dominantColor, `(å‡ºç°${maxCount}æ¬¡)`);
            
            return dominantColor;
        }

        // ç”Ÿæˆå åœç»“æœ
        function generateOmikujiResult(luckyColor) {
            const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const randomChoices = (arr, count) => {
                const shuffled = [...arr].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            };
            
            return {
                grade: wordBank.grade[0],
                lucky_color: luckyColor,
                yi: randomChoices(wordBank.yi, 3),
                ji: randomChoices(wordBank.ji, 3),
                lucky_item: randomChoice(wordBank.lucky_items),
                lucky_place: "CPä¼šåœºÂ·è°·è¯­æ‘Šä½",
                omikuji_text: randomChoice(wordBank.omikuji),
                warm_tip: randomChoice(wordBank.warm_tips)
            };
        }

        // å­—ä½“åŠ è½½æ£€æµ‹
        function loadFonts() {
            return new Promise((resolve) => {
                if (document.fonts) {
                    const checkFontLoaded = (fontFamily) => {
                        return document.fonts.check(`16px ${fontFamily}`);
                    };
                    
                    if (checkFontLoaded('FZYaSongT-R-GB') && checkFontLoaded('FZYaSongS-R-GB')) {
                        resolve();
                        return;
                    }
                    
                    const fontPromises = [
                        document.fonts.load('24px FZYaSongT-R-GB'),
                        document.fonts.load('20px FZYaSongS-R-GB'),
                        document.fonts.load('16px FZYaSongS-R-GB')
                    ];
                    
                    Promise.all(fontPromises).then(() => {
                        resolve();
                    }).catch((error) => {
                        console.log('å­—ä½“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
                        setTimeout(resolve, 3000);
                    });
                } else {
                    setTimeout(resolve, 3000);
                }
            });
        }

        // ç”Ÿæˆå›¾ç‰‡
        async function generateImage() {
            await loadFonts();
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 600;
            canvas.height = 800;
            
            const templates = [
                'public/å®šç¨¿1ï¼ˆfor å‰ç«¯ï¼‰.svg',
                'public/å®šç¨¿2ï¼ˆfor å‰ç«¯ï¼‰.svg'
            ];
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
            
            const svgImg = new Image();
            svgImg.onload = function() {
                ctx.drawImage(svgImg, 0, 0, 600, 800);
                
                // ç»˜åˆ¶å®œå¿Œå†…å®¹
                ctx.font = '20px FZYaSongS-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#000';
                
                let yiText = omikujiResult.yi.join(' ');
                let jiText = omikujiResult.ji.join(' ');
                
                const yiPhrases = yiText.split(' ').slice(0, 2);
                const yiDisplay = yiPhrases.join('  ');
                ctx.fillText(yiDisplay, 66.75 + 72, 505 + 20);
                
                const jiPhrases = jiText.split(' ').slice(0, 2);
                const jiDisplay = jiPhrases.join('  ');
                ctx.fillText(jiDisplay, 266.25 + 72, 505 + 20);
                
                // ç»˜åˆ¶å¹¸è¿ä¿¡æ¯
                ctx.font = '16px FZYaSongS-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#696969';
                
                ctx.fillText(omikujiResult.lucky_color, 152, 660 + 16);
                ctx.fillText(omikujiResult.lucky_item, 152, 687 + 16);
                ctx.fillText(omikujiResult.lucky_place, 152, 714 + 18);
                
                // ç»˜åˆ¶æ¸©é¦¨æé†’
                ctx.font = '20px FZYaSongS-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#000';
                ctx.fillText(omikujiResult.warm_tip, 74, 597 + 20);
                
                // ç»˜åˆ¶ç­¾æ–‡
                ctx.font = '24px FZYaSongT-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#000';
                
                const omikujiText = omikujiResult.omikuji_text;
                const charHeight = 25;
                const startX = 487 + 10;
                const startY = 477 + 30;
                
                for (let i = 0; i < omikujiText.length; i++) {
                    const char = omikujiText[i];
                    if (char && char !== ' ') {
                        ctx.save();
                        ctx.translate(startX, startY + i * charHeight);
                        ctx.fillText(char, 0, 0);
                        ctx.restore();
                    }
                }
                
                generatedImage = canvas.toDataURL('image/png', 1.0);
                showResult();
            };
            
            svgImg.src = randomTemplate;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult() {
            // éšè—ç­‰å¾…ç¯èŠ‚
            document.getElementById('waitingSection').classList.remove('show');
            document.getElementById('waitingSection').classList.add('hidden');
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('resultSection').classList.add('show');
            document.getElementById('resultImage').src = generatedImage;
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (generatedImage) {
                const link = document.createElement('a');
                link.download = `è°·è¯­æ—¥ç­¾-${omikujiResult.lucky_color}.png`;
                link.href = generatedImage;
                link.click();
            }
        }

        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            selectedFile = null;
            generatedImage = null;
            omikujiResult = null;
            
            document.getElementById('fileInput').value = '';
            document.getElementById('preview').innerHTML = '';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('triggerSection').classList.remove('hidden');
            document.getElementById('guideSection').classList.remove('show');
            document.getElementById('guideItem1').classList.remove('show');
            document.getElementById('guideItem2').classList.remove('show');
            document.getElementById('waitingSection').classList.remove('show');
            document.getElementById('waitingSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('show');
        }
    </script>
</body>
</html>