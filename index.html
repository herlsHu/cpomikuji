<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°·è¯­æ—¥ç­¾ - å¨ƒåŒ…è½»é™ªä¼´OC</title>
    
    <!-- å­—ä½“é¢„åŠ è½½ -->
    <link rel="preload" href="fonts/æ–¹æ­£æ ‡é›…å®‹ç¹ä½“.TTF" as="font" type="font/truetype" crossorigin>
    <link rel="preload" href="fonts/æ–¹æ­£æ ‡é›…å®‹ç®€ä½“.TTF" as="font" type="font/truetype" crossorigin>
    
    <style>
        @font-face {
            font-family: 'FZYaSongT-R-GB';
            src: url('fonts/æ–¹æ­£æ ‡é›…å®‹ç¹ä½“.TTF') format('truetype'),
                 local('FZYaSongT-R-GB'), 
                 local('æ–¹æ­£æ ‡é›…å®‹ç¹ä½“');
            font-display: block; /* å¼ºåˆ¶ç­‰å¾…å­—ä½“åŠ è½½å®Œæˆ */
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'FZYaSongS-R-GB';
            src: url('fonts/æ–¹æ­£æ ‡é›…å®‹ç®€ä½“.TTF') format('truetype'),
                 local('FZYaSongS-R-GB'),
                 local('æ–¹æ­£æ ‡é›…å®‹ç®€ä½“');
            font-display: block;
            font-weight: normal;
            font-style: normal;
        }
        
        /* å­—ä½“å›é€€æ–¹æ¡ˆ - å¦‚æœæ–¹æ­£å­—ä½“ä¸å¯ç”¨ï¼Œä½¿ç”¨ç›¸ä¼¼å­—ä½“ */
        .font-fallback {
            font-family: 'FZYaSongT-R-GB', 'Source Han Serif SC', 'æ€æºå®‹ä½“', 'Noto Serif SC', 'STSong', 'å®‹ä½“', serif;
        }
        
        .font-fallback-sans {
            font-family: 'FZYaSongS-R-GB', 'Source Han Serif SC', 'æ€æºå®‹ä½“', 'Noto Serif SC', 'STSong', 'å®‹ä½“', serif;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .upload-area {
            padding: 40px 30px;
            text-align: center;
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 40px 20px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-box:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .upload-box.dragover {
            border-color: #ff6b6b;
            background: #fff5f5;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ccc;
        }

        .upload-text {
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            box-shadow: none;
        }

        .preview {
            margin-top: 20px;
        }

        .preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            padding: 30px;
        }

        .result.show {
            display: block;
        }

        .result-image {
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }


        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .upload-area {
                padding: 30px 20px;
            }
            
            .upload-box {
                padding: 30px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>è°·è¯­æ—¥ç­¾</h1>
            <p>å¨ƒåŒ…è½»é™ªä¼´OC</p>
        </div>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    é€‰æ‹©å›¾ç‰‡
                </button>
            </div>
            
            <div class="preview" id="preview"></div>
            
            <button class="btn" id="generateBtn" onclick="generateOmikuji()" style="display: none;">
                ç”Ÿæˆæ—¥ç­¾
            </button>
            
            <button class="btn btn-secondary" id="resetBtn" onclick="resetUpload()" style="display: none;">
                é‡æ–°é€‰æ‹©
            </button>
        </div>

        <!-- åŠ è½½ä¸­ -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3>æ­£åœ¨ç”Ÿæˆæ—¥ç­¾...</h3>
            <p>è¯·ç¨å€™ï¼Œæ­£åœ¨å¤„ç†æ‚¨çš„å›¾ç‰‡</p>
        </div>

        <!-- ç»“æœå±•ç¤º -->
        <div class="result" id="result">
            <img id="resultImage" class="result-image" alt="ç”Ÿæˆçš„æ—¥ç­¾">
            
            
            <button class="btn" onclick="downloadImage()">
                ä¿å­˜å›¾ç‰‡
            </button>
            
            <button class="btn btn-secondary" onclick="resetUpload()">
                é‡æ–°ç”Ÿæˆ
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let selectedFile = null;
        let generatedImage = null;
        let omikujiResult = null;


        // è¯åº“æ•°æ®
        const wordBank = {
            "grade": ["å¤§å‰"],
            "yi": [
                "æ—©æ’é˜Ÿ","è½»è£…ä¸Š","äºŒå·¡é€›","è¡¥æ°´ç«™","æ‰“å¡ç‚¹","åˆç…§ç¤¼",
                "ç©¿èˆ’é‹","å¸¦å……ç”µ","è´´é˜²ç£¨","é˜²æ™’ä¼","å¤‡é›¨å…·","å°é›¶é’±",
                "è´´åç‰Œ","å­˜è¡Œæ","å…ˆå¤–åœˆ","çœ‹æŒ‡å¼•","æ’é˜Ÿè·","é¿å°–å³°",
                "å…ˆåƒé¥­","å–„è®©è·¯","ä¸»åŠ¨é—®","æ¸©å£°è¯­","å¸®æ‹ç…§","æ”¶ç¥¨æ®",
                "æ¢è½»åŒ…","æŠ¤é“å…·","æ‹‰æ‹‰é“¾","å…ˆè¯•ç¯","è®°æ‘Šå·","å¤‡æ¹¿å·¾",
                "æ¢å£ç½©","å›æ”¶è¢‹","é˜²èµ°å¤±","çº¦é›†åˆ","è½»å–ç‰©","å…ˆè§‚æ™¯",
                "éšæ‰‹é€’","ç¤¼è²Œé€€","å¤šå¾®ç¬‘","é€‚æ—¶ä¼‘",
                "çœ‹åœºåˆŠ","æŒ‰åŠ¨çº¿","æ ‡è¿”å›¾","æ‰©åˆ—ç¤¼","æŠ¤å‡å‘","æ”¶å°ç« ",
                "é¿åå…‰","å…³é—ªå…‰","ç•™ç©ºé“","è®©åæ’"
            ],
            "ji": [
                "ä¹…ä¹…ç«™","å¿˜å……ç”µ","ç¡¬æŠ¢ä½","å¤§åŒ…è£¹","ç©ºè…¹é€›",
                "æ’é˜ŸæŠ¢","å¤§å£°åµ","ä¹±æ‹æ‘„","æœªåŒæ„","æŒ¤å‹äºº",
                "æ‰åƒåœ¾","æ’é“å…·","è¸©è£™æ‘†","è¿½ç€æ‹","ä¹…ä¸æ°´",
                "è¿‡åº¦æ™’","ç©¿æ–°é‹","æ‹–åœ°è£™","ç´§è·Ÿæ‹","å µé€šé“",
                "å åº§ä¹…","é—ªç¯çŒ›","æ‹‰ä»–äºº","ä¹±è´´ç­¾","ä¸¢ç¥¨è¯",
                "æ”¾éšåœ°","å–å¤ªå°‘","è´Ÿé‡å¤š","æ¨æ¡äºº","ä¹±ç¿»åŒ…",
                "æœªæ’é˜Ÿ","è¶ŠæŠ¤æ ","é†‰é…’é€›","é€¼åˆç…§","ç¡¬å€Ÿç‰©",
                "ä¹±æ‰©åˆ—","å¼€é—ªå…‰","æŒ¡é€šé“","è´´äººæ‹","è¸©é“å…·",
                "ä¹±ç›–ç« ","æŒ¡æ‘Šä½","å æœºä½"
            ],
            "lucky_items": ["æ‰“å¡æ£’","è¢‹å­"],
            "omikuji": [
                "å¿µå¿µä¸å¿˜ å¿…æœ‰å›å“",
                "æ—©åˆ°ä¸æ€¥ å¥½ä½è‡ªç•™",
                "ç¯ç‰Œä½œæœˆ å‡ºç‰‡æ›´ç¨³",
                "äºŒå·¡æœ‰ç¼˜ æ¼ç½‘å…¥è¢‹",
                "åœºåˆŠåœ¨æ‰‹ æ–¹å‘è‡ªæ˜",
                "ç¤¼è²Œå…ˆè¡Œ ç¼˜åˆ†é è¿‘",
                "å…ˆé—®åæ‹ å‡ºç‰‡è‡ªæ¥",
                "æ‰©åˆ—é¡ºåˆ© æœ‹å‹å¸¸ä¼´",
                "æ­£ç‰‡æœ‰æœŸ è¿”å›¾å¦‚çº¦",
                "è°·å­åˆ°æ‰‹ å¿ƒæ»¡æ„è¶³",
                "å§å”§å®å½“ æ¬§æ°”æŠ¤ä½“",
                "ç—›åŒ…é—ªäº® äººæµ·å‘å…‰",
                "é”™å³°è€Œè¡Œ è„šæ­¥è½»å¿«",
                "æ’é˜Ÿæœ‰åº æ¬§æ°”é è¿‘",
                "è½»è£…ä¸Šé˜µ é£ç”Ÿæ°´èµ·",
                "é›†ç« é›†å‹ å¿«ä¹åŠ å€",
                "è¿”åœºå°èš å¥½è¿åŠ å€",
                "å¤–åœºå¾®é£ ç…§ç‰‡ç”ŸèŠ±",
                "æ¸©å£°ç›¸å¾… å¥½äº‹ä¸Šé—¨",
                "è¿·è·¯ä¸æ…Œ åŸåœ°ç­‰å‹",
                "é¥®æ°´åŠæ—¶ ä½“åŠ›å¸¸é’",
                "è¿œå…‰ä½œä¼´ å½±åƒç”Ÿè¾‰",
                "æŒ‡å—åœ¨æ‰‹ åŠ¨çº¿æ˜æ™°",
                "åˆç…§å¾®ç¬‘ è®°å¾—è‡´è°¢",
                "æŠ¤å¥½å‡å‘ ç»†èŠ‚åœ¨çº¿",
                "æŒ‚ä»¶ç¨³å›º ç—›åŒ…å®‰å¿ƒ",
                "æ”¶çº³æœ‰æœ¯ æˆ˜åˆ©æ»¡è¢‹",
                "ä»Šæ—¥é¡ºå¿ƒ ä¸‡äº‹èƒœæ„",
                "äº‘å¼€è§ä½  ç¦æ·»ä¸€å±‚",
                "å¿ƒæœ‰çƒ­çˆ± å®‡å®™å›å“",
                "ç¯ç«å¯äº² ç¬‘è„¸å¸¸æ–°"
            ],
            "warm_tips": [
                "é”™å³°äºŒå·¡æ›´è½»æ¾",
                "ç¯ç‰Œè¡¥å…‰æ›´é€šé€",
                "æ’é˜Ÿç•™é—´è·å°±å¥½",
                "åˆç…§æœ‰ç¤¼æ›´å¥½çœ‹",
                "ç—›åŒ…æŒ‚ç‰¢æ›´å®‰å¿ƒ",
                "å§å”§å¥—å£³ä¸åˆ®èŠ±",
                "å…ˆåƒå†é€›æ›´è€ä¹…",
                "ç¥¨è¯æ”¶å¥½æ›´çœå¿ƒ",
                "é›†ç« æ…¢æ…¢ç›–ä¸ç€æ€¥",
                "æ‰©åˆ—è‡ªæˆ‘ä»‹ç»å…ˆ",
                "å–œæ¬¢å°±è¡¨è¾¾è¯•è¯•",
                "å–æ°´ä¼‘æ¯æ›´æœ‰åŠ²",
                "è¿œå…‰ä¾§èº«æ›´é€šé€",
                "æŒ‡å—åœ¨æ‰‹æ›´è¸å®"
            ]
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadBox = document.getElementById('uploadBox');
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½äº‹ä»¶
            uploadBox.addEventListener('dragover', handleDragOver);
            uploadBox.addEventListener('dragleave', handleDragLeave);
            uploadBox.addEventListener('drop', handleDrop);
        });

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedFile = file;
                showPreview(file);
                analyzeImageAndGenerate(file);
            }
        }

        // å¤„ç†æ‹–æ‹½
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    selectedFile = file;
                    showPreview(file);
                    analyzeImageAndGenerate(file);
                }
            }
        }

        // åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆæ—¥ç­¾
        function analyzeImageAndGenerate(file) {
            const img = new Image();
            img.onload = function() {
                // åˆ›å»ºcanvasæ¥åˆ†æå›¾ç‰‡é¢œè‰²
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                
                // ç»˜åˆ¶å›¾ç‰‡åˆ°canvas
                ctx.drawImage(img, 0, 0);
                
                // è·å–å›¾ç‰‡æ•°æ®
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // åˆ†æä¸»è‰²è°ƒ
                const dominantColor = analyzeImageColor(imageData);
                console.log('åˆ†æåˆ°çš„ä¸»è‰²è°ƒ:', dominantColor);
                
                // ç”Ÿæˆæ—¥ç­¾ç»“æœ
                omikujiResult = generateOmikujiResult(dominantColor);
                
                // æ˜¾ç¤ºç”ŸæˆæŒ‰é’®
                showGenerateButton();
            };
            
            img.src = URL.createObjectURL(file);
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview(file) {
            const preview = document.getElementById('preview');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆå›¾ç‰‡">`;
            };
            
            reader.readAsDataURL(file);
        }

        // æ˜¾ç¤ºç”ŸæˆæŒ‰é’®
        function showGenerateButton() {
            document.getElementById('generateBtn').style.display = 'block';
            document.getElementById('resetBtn').style.display = 'block';
        }

        // ç”Ÿæˆå åœç»“æœ
        function generateOmikuji() {
            if (!selectedFile) return;
            
            showLoading();
            
            // ç›´æ¥ä½¿ç”¨å·²åˆ†æçš„é¢œè‰²ç”Ÿæˆå›¾ç‰‡
            setTimeout(async () => {
                await generateImage();
            }, 2000);
        }

        // æ˜¾ç¤ºåŠ è½½ä¸­
        function showLoading() {
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('loading').classList.add('show');
        }

        // è·å–éšæœºé¢œè‰²
        function getRandomColor() {
            const colors = ["ç™½","é»‘","çº¢","æ©™","é»„","ç»¿","é’","è“","ç´«","ç²‰"];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // RGBè½¬HSL
        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // æ— è‰²
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            
            return [h * 360, s * 100, l * 100];
        }

        // åˆ†æå›¾ç‰‡ä¸»è‰²è°ƒ - ä¼˜åŒ–ç‰ˆHSLè‰²å½©ç©ºé—´
        function analyzeImageColor(imageData) {
            const data = imageData.data;
            const colorCounts = {};
            const sampleSize = 2000; // å¢åŠ é‡‡æ ·ç‚¹æ•°é‡
            
            // åˆ†å±‚é‡‡æ ·ï¼šä¸­å¿ƒåŒºåŸŸæƒé‡æ›´é«˜
            const width = imageData.width;
            const height = imageData.height;
            const centerX = width / 2;
            const centerY = height / 2;
            
            for (let i = 0; i < sampleSize; i++) {
                let x, y;
                
                // 70%æ¦‚ç‡é‡‡æ ·ä¸­å¿ƒåŒºåŸŸï¼Œ30%æ¦‚ç‡é‡‡æ ·è¾¹ç¼˜
                if (Math.random() < 0.7) {
                    // ä¸­å¿ƒåŒºåŸŸé‡‡æ ·
                    x = Math.floor(centerX + (Math.random() - 0.5) * width * 0.6);
                    y = Math.floor(centerY + (Math.random() - 0.5) * height * 0.6);
                } else {
                    // å…¨å›¾éšæœºé‡‡æ ·
                    x = Math.floor(Math.random() * width);
                    y = Math.floor(Math.random() * height);
                }
                
                const index = (y * width + x) * 4;
                const r = data[index];
                const g = data[index + 1];
                const b = data[index + 2];
                const a = data[index + 3];
                
                // è·³è¿‡é€æ˜åƒç´ å’Œè¿‡æš—åƒç´ 
                if (a < 128 || (r < 30 && g < 30 && b < 30)) continue;
                
                // è½¬æ¢ä¸ºHSL
                const [h, s, l] = rgbToHsl(r, g, b);
                
                // ä¼˜åŒ–é¢œè‰²åˆ¤æ–­é€»è¾‘
                let colorName = "ç™½";
                
                // æä½äº®åº¦ = é»‘è‰²
                if (l < 10) {
                    colorName = "é»‘";
                }
                // ä½é¥±å’Œåº¦ = ç™½è‰²/ç°è‰²
                else if (s < 15) {
                    colorName = l > 60 ? "ç™½" : "é»‘";
                }
                // é«˜äº®åº¦ä½é¥±å’Œåº¦ = ç™½è‰²
                else if (l > 80 && s < 30) {
                    colorName = "ç™½";
                }
                // æ ¹æ®è‰²ç›¸åˆ¤æ–­é¢œè‰²ï¼ˆè°ƒæ•´é˜ˆå€¼ï¼‰
                else if (h >= 0 && h < 20) colorName = "çº¢";
                else if (h >= 20 && h < 50) colorName = "æ©™";
                else if (h >= 50 && h < 80) colorName = "é»„";
                else if (h >= 80 && h < 160) colorName = "ç»¿";
                else if (h >= 160 && h < 200) colorName = "é’";
                else if (h >= 200 && h < 260) colorName = "è“";
                else if (h >= 260 && h < 300) colorName = "ç´«";
                else if (h >= 300 && h < 340) colorName = "ç²‰";
                else colorName = "çº¢"; // 340-360åº¦å›åˆ°çº¢è‰²
                
                colorCounts[colorName] = (colorCounts[colorName] || 0) + 1;
            }
            
            // æ‰¾åˆ°å‡ºç°æ¬¡æ•°æœ€å¤šçš„é¢œè‰²
            let maxCount = 0;
            let dominantColor = "ç™½";
            for (const [color, count] of Object.entries(colorCounts)) {
                if (count > maxCount) {
                    maxCount = count;
                    dominantColor = color;
                }
            }
            
            // å¦‚æœé‡‡æ ·ç‚¹å¤ªå°‘ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            if (maxCount < 10) {
                console.log('é‡‡æ ·ç‚¹ä¸è¶³ï¼Œä½¿ç”¨éšæœºé¢œè‰²');
                const colors = ["ç™½","é»‘","çº¢","æ©™","é»„","ç»¿","é’","è“","ç´«","ç²‰"];
                return colors[Math.floor(Math.random() * colors.length)];
            }
            
            console.log('HSLé¢œè‰²åˆ†æç»“æœ:', colorCounts);
            console.log('ä¸»è‰²è°ƒ:', dominantColor, `(å‡ºç°${maxCount}æ¬¡)`);
            
            return dominantColor;
        }

        // ç”Ÿæˆå åœç»“æœ
        function generateOmikujiResult(luckyColor) {
            const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const randomChoices = (arr, count) => {
                const shuffled = [...arr].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            };
            
            return {
                grade: wordBank.grade[0],
                lucky_color: luckyColor,
                yi: randomChoices(wordBank.yi, 3),
                ji: randomChoices(wordBank.ji, 3),
                lucky_item: randomChoice(wordBank.lucky_items),
                lucky_place: "CPä¼šåœºÂ·è°·è¯­æ‘Šä½",
                omikuji_text: randomChoice(wordBank.omikuji),
                warm_tip: randomChoice(wordBank.warm_tips)
            };
        }

        // ç”Ÿæˆå›¾ç‰‡
        // å­—ä½“åŠ è½½æ£€æµ‹
        // å­—ä½“åŠ è½½å‡½æ•° - å¼ºåˆ¶ç­‰å¾…å­—ä½“åŠ è½½å®Œæˆ
        function loadFonts() {
            return new Promise((resolve) => {
                if (document.fonts) {
                    // æ£€æŸ¥å­—ä½“æ˜¯å¦å·²åŠ è½½
                    const checkFontLoaded = (fontFamily) => {
                        return document.fonts.check(`16px ${fontFamily}`);
                    };
                    
                    // å¦‚æœå­—ä½“å·²åŠ è½½ï¼Œç›´æ¥è¿”å›
                    if (checkFontLoaded('FZYaSongT-R-GB') && checkFontLoaded('FZYaSongS-R-GB')) {
                        console.log('å­—ä½“å·²åŠ è½½');
                        resolve();
                        return;
                    }
                    
                    // é¢„åŠ è½½å­—ä½“
                    const fontPromises = [
                        document.fonts.load('24px FZYaSongT-R-GB'),
                        document.fonts.load('20px FZYaSongS-R-GB'),
                        document.fonts.load('16px FZYaSongS-R-GB')
                    ];
                    
                    Promise.all(fontPromises).then(() => {
                        console.log('æ‰€æœ‰å­—ä½“åŠ è½½å®Œæˆ');
                        resolve();
                    }).catch((error) => {
                        console.log('å­—ä½“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ:', error);
                        setTimeout(resolve, 3000);
                    });
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆ
                    console.log('document.fonts ä¸æ”¯æŒï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    setTimeout(resolve, 3000);
                }
            });
        }

        // æ£€æµ‹å­—ä½“æ˜¯å¦å¯ç”¨
        function checkFontAvailable(fontFamily) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®æµ‹è¯•å­—ä½“
            ctx.font = '16px ' + fontFamily;
            const testText = 'æµ‹è¯•å­—ä½“';
            const metrics1 = ctx.measureText(testText);
            
            // è®¾ç½®å¤‡ç”¨å­—ä½“
            ctx.font = '16px serif';
            const metrics2 = ctx.measureText(testText);
            
            // å¦‚æœå®½åº¦ä¸åŒï¼Œè¯´æ˜å­—ä½“å·²åŠ è½½
            return metrics1.width !== metrics2.width;
        }

        async function generateImage() {
            // ç­‰å¾…å­—ä½“åŠ è½½å®Œæˆ
            await loadFonts();
            
            // æ£€æµ‹å­—ä½“æ˜¯å¦çœŸæ­£å¯ç”¨
            if (!checkFontAvailable('FZYaSongT-R-GB')) {
                console.warn('æ–¹æ­£æ ‡é›…å®‹ç¹ä½“å­—ä½“æœªåŠ è½½ï¼Œå¯èƒ½å½±å“ç­¾æ–‡æ˜¾ç¤º');
            }
            if (!checkFontAvailable('FZYaSongS-R-GB')) {
                console.warn('æ–¹æ­£æ ‡é›…å®‹ç®€ä½“å­—ä½“æœªåŠ è½½ï¼Œå¯èƒ½å½±å“å…¶ä»–æ–‡å­—æ˜¾ç¤º');
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸º600x800ï¼ˆåŒ¹é…SVGæ¨¡æ¿ï¼‰
            canvas.width = 600;
            canvas.height = 800;
            
            // éšæœºé€‰æ‹©æ¨¡æ¿
            const templates = [
                'public/å®šç¨¿1ï¼ˆfor å‰ç«¯ï¼‰.svg',
                'public/å®šç¨¿2ï¼ˆfor å‰ç«¯ï¼‰.svg'
            ];
            const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
            console.log('ä½¿ç”¨æ¨¡æ¿:', randomTemplate); // è°ƒè¯•ä¿¡æ¯
            
            // åˆ›å»ºSVGå›¾åƒ
            const svgImg = new Image();
            svgImg.onload = function() {
                // ç»˜åˆ¶SVGèƒŒæ™¯
                ctx.drawImage(svgImg, 0, 0, 600, 800);
                
                // ç»˜åˆ¶å®œå¿Œå†…å®¹ï¼ˆæ ¹æ®SVGç°è‰²æ¡†ç²¾ç¡®ä½ç½®ï¼‰
                ctx.font = '20px FZYaSongS-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#000';
                
                // é™åˆ¶å®œå¿Œæ–‡æœ¬é•¿åº¦ä¸è¶…è¿‡150åƒç´ 
                let yiText = omikujiResult.yi.join(' ');
                let jiText = omikujiResult.ji.join(' ');
                
                // è®¾ç½®å®œå¿Œæ–‡å­—æ ·å¼
                ctx.font = '20px FZYaSongS-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                
                // å®œå†…å®¹ - åªæ˜¾ç¤ºä¸¤ä¸ªä¸‰å­—çŸ­è¯­ï¼Œå¢åŠ é—´è·
                const yiPhrases = yiText.split(' ').slice(0, 2);
                const yiDisplay = yiPhrases.join('  '); // ä¸¤ä¸ªç©ºæ ¼å¢åŠ é—´è·
                ctx.fillText(yiDisplay, 66.75 + 72, 505 + 20); // å†å¾€å³è°ƒæ•´2åƒç´ 
                
                // å¿Œå†…å®¹ - åªæ˜¾ç¤ºä¸¤ä¸ªä¸‰å­—çŸ­è¯­ï¼Œå¢åŠ é—´è·
                const jiPhrases = jiText.split(' ').slice(0, 2);
                const jiDisplay = jiPhrases.join('  '); // ä¸¤ä¸ªç©ºæ ¼å¢åŠ é—´è·
                ctx.fillText(jiDisplay, 266.25 + 72, 505 + 20); // å†å¾€å³è°ƒæ•´2åƒç´ 
                
                // ç»˜åˆ¶å¹¸è¿ä¿¡æ¯ï¼ˆæ ¹æ®SVGç°è‰²æ¡†å·¦ä¸Šè§’ä½ç½®ï¼Œåªæ˜¾ç¤ºå†…å®¹ï¼‰
                ctx.font = '16px FZYaSongS-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#696969';
                
                // å¹¸è¿è‰² - æ ¹æ®SVGç°è‰²æ¡† (152, 660, 33, 23) å·¦ä¸Šè§’å¼€å§‹
                ctx.fillText(omikujiResult.lucky_color, 152, 660 + 16);
                
                // å¹¸è¿ç‰© - æ ¹æ®SVGç°è‰²æ¡† (152, 687, 33, 23) å·¦ä¸Šè§’å¼€å§‹
                ctx.fillText(omikujiResult.lucky_item, 152, 687 + 16);
                
                // å¹¸è¿åœ° - æ ¹æ®SVGç°è‰²æ¡† (152, 714, 33, 23) å·¦ä¸Šè§’å¼€å§‹
                ctx.fillText(omikujiResult.lucky_place, 152, 714 + 18);
                
                // ç»˜åˆ¶æ¸©é¦¨æé†’ï¼ˆæ ¹æ®æ‚¨æä¾›çš„ä½ç½®ï¼Œå»æ‰å‰ç¼€ï¼‰
                ctx.font = '20px FZYaSongS-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#000';
                ctx.fillText(omikujiResult.warm_tip, 74, 597 + 20);
                
                // ç»˜åˆ¶ç­¾æ–‡ï¼ˆæ ¹æ®SVGç°è‰²æ¡†å·¦ä¸Šè§’ä½ç½®ï¼Œç«–å‘æ’åˆ—ï¼Œæ–‡å­—æ­£ç€ï¼‰
                ctx.font = '24px FZYaSongT-R-GB, "Source Han Serif SC", "æ€æºå®‹ä½“", "Noto Serif SC", "STSong", "å®‹ä½“", serif'; // æ–¹æ­£æ ‡é›…å®‹ç¹ä½“ + å›é€€å­—ä½“
                ctx.textAlign = 'center';
                ctx.fillStyle = '#000';
                
                const omikujiText = omikujiResult.omikuji_text;
                const charHeight = 25; // æ ¹æ®ç°è‰²æ¡†é«˜åº¦261/å­—ç¬¦æ•°è°ƒæ•´
                // æ ¹æ®SVGç°è‰²æ¡† (487, 477, 26, 261) è°ƒæ•´ä½ç½®
                const startX = 487 + 10; // å¾€å·¦è°ƒæ•´
                const startY = 477 + 30; // å¾€ä¸‹è°ƒæ•´
                
                // ä»ä¸Šåˆ°ä¸‹å‚ç›´æ’åˆ—ï¼Œæ¯ä¸ªå­—éƒ½æ˜¯æ­£ç«‹çš„
                for (let i = 0; i < omikujiText.length; i++) {
                    const char = omikujiText[i];
                    if (char && char !== ' ') {
                        ctx.save();
                        // ç›´æ¥ä»ä¸Šåˆ°ä¸‹æ’åˆ—ï¼Œä¸æ—‹è½¬
                        ctx.translate(startX, startY + i * charHeight);
                        ctx.fillText(char, 0, 0);
                        ctx.restore();
                    }
                }
                
                
                // è½¬æ¢ä¸ºå›¾ç‰‡
                generatedImage = canvas.toDataURL('image/png', 1.0);
                showResult();
            };
            
            // åŠ è½½SVGæ¨¡æ¿
            svgImg.src = randomTemplate;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult() {
            document.getElementById('loading').classList.remove('show');
            document.getElementById('result').classList.add('show');
            
            // æ˜¾ç¤ºç»“æœå›¾ç‰‡
            document.getElementById('resultImage').src = generatedImage;
            
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (generatedImage) {
                const link = document.createElement('a');
                link.download = `è°·è¯­æ—¥ç­¾-${omikujiResult.lucky_color}.png`;
                link.href = generatedImage;
                link.click();
            }
        }

        // é‡ç½®ä¸Šä¼ 
        function resetUpload() {
            selectedFile = null;
            generatedImage = null;
            omikujiResult = null;
            
            document.getElementById('fileInput').value = '';
            document.getElementById('preview').innerHTML = '';
            document.getElementById('generateBtn').style.display = 'none';
            document.getElementById('resetBtn').style.display = 'none';
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('loading').classList.remove('show');
            document.getElementById('result').classList.remove('show');
        }
    </script>
</body>
</html>
